<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Custom Selection Menu</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      margin-bottom: 20px;
    }

    p {
      margin-bottom: 15px;
    }

    /* Allow selection only on content areas */
    .selectable {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    ::selection {
      background: #b3d4fc;
    }

    #selectionMenu {
      position: absolute;
      display: none;
      background: #333;
      color: white;
      border-radius: 6px;
      padding: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      pointer-events: auto;
    }

    #selectionMenu button {
      background: transparent;
      border: none;
      color: white;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 4px;
      margin: 0 2px;
      -webkit-tap-highlight-color: transparent;
    }

    #selectionMenu button:hover,
    #selectionMenu button:active {
      background: #555;
    }
  </style>
</head>
<body>
  <h1>Custom Selection Menu Demo</h1>
  
  <p class="selectable">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
  
  <p class="selectable">Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
  
  <p class="selectable">Select any text on this page to see the custom menu appear. Try it on both desktop and mobile devices!</p>

  <div id="selectionMenu">
    <button id="copyBtn">Copy</button>
    <button id="shareBtn">Share</button>
    <button id="searchBtn">Search</button>
  </div>

  <script>
    const menu = document.getElementById('selectionMenu');
    const copyBtn = document.getElementById('copyBtn');
    const shareBtn = document.getElementById('shareBtn');
    const searchBtn = document.getElementById('searchBtn');
    
    let selectedText = '';
    let selectionTimeout;

    // Disable right-click menu
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });

    // Prevent default actions on selection
    document.addEventListener('selectstart', (e) => {
      // Allow selection but prepare to override default menu
    });

    // Override copy/cut commands to prevent default menu
    document.addEventListener('copy', (e) => {
      if (selectedText) {
        e.preventDefault();
        e.clipboardData.setData('text/plain', selectedText);
      }
    });

    document.addEventListener('cut', (e) => {
      e.preventDefault();
    });

    // Show menu on text selection
    function showMenu() {
      clearTimeout(selectionTimeout);
      
      const selection = window.getSelection();
      selectedText = selection.toString().trim();
      
      if (selectedText.length > 0) {
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        
        // Position menu above selection
        const menuLeft = rect.left + (rect.width / 2) - 75 + window.scrollX;
        const menuTop = rect.top + window.scrollY - 50;
        
        menu.style.left = Math.max(10, menuLeft) + 'px';
        menu.style.top = Math.max(10, menuTop) + 'px';
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    }

    // Hide menu
    function hideMenu() {
      menu.style.display = 'none';
      window.getSelection().removeAllRanges();
    }

    // Desktop: mouse selection
    document.addEventListener('mouseup', (e) => {
      if (!menu.contains(e.target)) {
        selectionTimeout = setTimeout(showMenu, 50);
      }
    });

    // Mobile: touch selection - more aggressive approach
    let touchSelectionHandler;
    document.addEventListener('selectionchange', () => {
      clearTimeout(touchSelectionHandler);
      touchSelectionHandler = setTimeout(() => {
        const selection = window.getSelection();
        if (selection.toString().trim().length > 0) {
          showMenu();
        }
      }, 100);
    });

    // Prevent default menu on touchend
    document.addEventListener('touchend', (e) => {
      if (window.getSelection().toString().trim().length > 0) {
        // Small delay to let our menu appear
        setTimeout(() => {
          const sel = window.getSelection();
          if (sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        }, 10);
      }
    }, { passive: true });

    // Hide menu on click/touch outside
    document.addEventListener('mousedown', (e) => {
      if (!menu.contains(e.target)) {
        setTimeout(hideMenu, 100);
      }
    });

    document.addEventListener('touchstart', (e) => {
      if (!menu.contains(e.target) && menu.style.display === 'block') {
        hideMenu();
      }
    }, { passive: true });

    // Copy action
    copyBtn.addEventListener('click', (e) => {
      e.preventDefault();
      navigator.clipboard.writeText(selectedText).then(() => {
        alert('Copied: ' + selectedText);
        hideMenu();
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = selectedText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Copied: ' + selectedText);
        hideMenu();
      });
    });

    // Share action
    shareBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (navigator.share) {
        navigator.share({
          text: selectedText
        }).then(() => {
          hideMenu();
        }).catch(() => {
          alert('Share: ' + selectedText);
          hideMenu();
        });
      } else {
        alert('Share: ' + selectedText);
        hideMenu();
      }
    });

    // Search action
    searchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      window.open('https://www.google.com/search?q=' + encodeURIComponent(selectedText), '_blank');
      hideMenu();
    });

    // Prevent menu buttons from losing selection
    menu.addEventListener('touchstart', (e) => {
      e.stopPropagation();
    }, { passive: true });
  </script>
</body>
</html>
